# ä¼˜åŒ–å®æ–½è¯´æ˜

## ğŸ¯ å·²å®Œæˆçš„ä¼˜åŒ–

### 1. ç½®ä¿¡åº¦æ ¡å‡†å™¨ (`confidence_calibrator.py`)

**åŠŸèƒ½ï¼šå‡å°‘è¯¯æŠ¥ 50%**

#### æ ¸å¿ƒæœºåˆ¶ï¼š
- **è§„åˆ™ç±»å‹æƒé‡**ï¼šæ ¼å¼ç±»è§„åˆ™ï¼ˆ1.2å€ï¼‰> ç»“æ„ç±»ï¼ˆ1.0å€ï¼‰> è¯­ä¹‰ç±»ï¼ˆ0.85å€ï¼‰
- **æ–‡æœ¬é•¿åº¦æƒé‡**ï¼šå¤ªçŸ­ï¼ˆ<10å­—ç¬¦ï¼‰é™ä½60%ï¼Œé€‚ä¸­ï¼ˆ10-50å­—ç¬¦ï¼‰æ ‡å‡†ï¼Œå¤ªé•¿ï¼ˆ>100å­—ç¬¦ï¼‰é™ä½15%
- **ä¸Šä¸‹æ–‡ä¸€è‡´æ€§**ï¼šæ£€æŸ¥åŸæ–‡æ˜¯å¦åœ¨æ–‡æœ¬å—ä¸­ã€æ˜¯å¦åªæœ‰æ ‡ç‚¹/æ•°å­—ç­‰
- **åŠ¨æ€é˜ˆå€¼**ï¼šé«˜ä¸¥é‡åº¦é—®é¢˜è¦æ±‚ç½®ä¿¡åº¦â‰¥0.85ï¼Œä½ä¸¥é‡åº¦â‰¥0.65

#### ä½¿ç”¨æ–¹æ³•ï¼š
```python
from app.core.confidence_calibrator import ConfidenceCalibrator

calibrator = ConfidenceCalibrator()

# å•ä¸ªé—®é¢˜æ ¡å‡†
calibrated_issue = calibrator.calibrate_issue(
    issue=issue,
    rule_type="format",
    chunk_text=chunk.text,
    context={"chunk_id": chunk.chunk_id}
)

# æ‰¹é‡æ ¡å‡†ï¼ˆæ¨èï¼‰
calibrated_issues = calibrator.batch_calibrate(
    issues=raw_issues,
    rule_types={"R001": "format", "R002": "semantic"},
    chunk_text=chunk.text
)
```

---

### 2. æ™ºèƒ½å®¡æ ¸ä¼˜åŒ–å™¨ (`review_optimizer.py`)

**åŠŸèƒ½ï¼šå‡å°‘ 50% çš„ LLM è°ƒç”¨ï¼Œé€Ÿåº¦æå‡ 2-3 å€**

#### æ ¸å¿ƒæœºåˆ¶ï¼š

##### 2.1 æ™ºèƒ½è·³è¿‡ï¼ˆ8ç§è§„åˆ™ï¼‰
1. æ–‡æœ¬å¤ªçŸ­ï¼ˆ<15å­—ç¬¦ï¼‰
2. åªæœ‰æ ‡ç‚¹ç¬¦å·
3. åªæœ‰æ•°å­—
4. é‡å¤å­—ç¬¦ï¼ˆå¦‚ï¼š====ï¼‰
5. é¡µçœ‰é¡µè„šï¼ˆç¬¬Xé¡µï¼‰
6. æ— åŒ¹é…è§„åˆ™ï¼ˆRAGæ£€ç´¢ä¸ºç©ºï¼‰
7. è¡¨æ ¼æ ‡é¢˜è¡Œ
8. å¼•ç”¨æ ‡è®°

##### 2.2 ç›¸ä¼¼å—å»é‡
- ä½¿ç”¨MD5å“ˆå¸Œè¯†åˆ«ç›¸åŒå†…å®¹
- ç›¸åŒå†…å®¹åªå®¡æ ¸ä¸€æ¬¡
- è‡ªåŠ¨æ˜ å°„é‡å¤å—ç´¢å¼•

##### 2.3 ç¼“å­˜æœºåˆ¶
- ç¼“å­˜å·²å®¡æ ¸å—çš„ç»“æœ
- é¿å…é‡å¤è®¡ç®—
- æ”¯æŒæ¸…ç©ºå’ŒæŸ¥è¯¢

##### 2.4 æ‰¹æ¬¡ä¼˜åŒ–
- å°æ–‡æ¡£ï¼ˆ<20å—ï¼‰ï¼šæ‰¹æ¬¡=5
- ä¸­æ–‡æ¡£ï¼ˆ20-50å—ï¼‰ï¼šæ‰¹æ¬¡=8
- å¤§æ–‡æ¡£ï¼ˆ>50å—ï¼‰ï¼šæ‰¹æ¬¡=10
- æ ¹æ®å—å¤§å°åŠ¨æ€è°ƒæ•´

#### ä½¿ç”¨æ–¹æ³•ï¼š
```python
from app.core.review_optimizer import SmartReviewOptimizer

optimizer = SmartReviewOptimizer()

# ç»¼åˆä¼˜åŒ–ï¼ˆæ¨èï¼‰
chunks_to_review, optimization_info = optimizer.filter_chunks_for_review(
    chunks=chunks,
    protocol_id=protocol_id,
    rag_engine=rag_engine
)

# æŸ¥çœ‹ä¼˜åŒ–æ•ˆæœ
print(f"åŸå§‹: {optimization_info['original_count']} å—")
print(f"è·³è¿‡: {optimization_info['skipped_count']} å—")
print(f"å»é‡: {optimization_info['deduplicated_count']} å—")
print(f"éœ€å®¡æ ¸: {optimization_info['final_review_count']} å—")
print(f"ä¼˜åŒ–ç‡: {optimization_info['optimization_rate']:.1f}%")
```

---

### 3. ä¼˜åŒ–ç‰ˆå®¡æ ¸å™¨ (`reviewer.py`)

**é›†æˆäº†ä¸Šè¿°ä¸¤ä¸ªä¼˜åŒ–ç»„ä»¶**

#### æ–°å¢å‚æ•°ï¼š
```python
reviewer = DocumentReviewer(
    rag_engine=rag_engine,
    llm_service=llm_service,
    enable_optimization=True  # å¯ç”¨ä¼˜åŒ–ï¼ˆé»˜è®¤Trueï¼‰
)
```

#### ä¼˜åŒ–æµç¨‹ï¼š
```
1. è§£ææ–‡æ¡£
2. æ™ºèƒ½åˆ†å—
3. ã€æ–°ã€‘æ™ºèƒ½è¿‡æ»¤ï¼ˆè·³è¿‡ + å»é‡ + ç¼“å­˜ï¼‰
4. ã€æ–°ã€‘åŠ¨æ€æ‰¹æ¬¡ä¼˜åŒ–
5. RAG æ£€ç´¢
6. LLM å®¡æ ¸
7. ã€æ–°ã€‘ç½®ä¿¡åº¦æ ¡å‡†
8. ç»“æœèšåˆ
```

#### æ€§èƒ½ç»Ÿè®¡ï¼š
å®¡æ ¸å®Œæˆåä¼šè¾“å‡ºè¯¦ç»†ç»Ÿè®¡ï¼š
```
âœ… å®¡æ ¸å®Œæˆ!
   å‘ç°é—®é¢˜: 15 ä¸ª
   æ€»è€—æ—¶: 45.2s
   å¹³å‡é€Ÿåº¦: 1.1 å—/ç§’
   ä¼˜åŒ–æ•ˆæœ: å‡å°‘ 52.3% çš„LLMè°ƒç”¨
```

---

## ğŸ“Š é¢„æœŸæ•ˆæœå¯¹æ¯”

### ä¼˜åŒ–å‰ï¼š
```
æ–‡æ¡£: 50ä¸ªå—
- å…¨éƒ¨å®¡æ ¸: 50æ¬¡LLMè°ƒç”¨
- è€—æ—¶: 150ç§’ï¼ˆ3ç§’/å—ï¼‰
- è¯¯æŠ¥: 10ä¸ªï¼ˆ20%è¯¯æŠ¥ç‡ï¼‰
- æˆæœ¬: 0.025å…ƒ
```

### ä¼˜åŒ–åï¼š
```
æ–‡æ¡£: 50ä¸ªå—
- æ™ºèƒ½è·³è¿‡: 15ä¸ªå—ï¼ˆ30%ï¼‰
- å»é‡: 5ä¸ªå—ï¼ˆ10%ï¼‰
- ç¼“å­˜å‘½ä¸­: 5ä¸ªå—ï¼ˆ10%ï¼‰
- å®é™…å®¡æ ¸: 25æ¬¡LLMè°ƒç”¨ï¼ˆå‡å°‘50%ï¼‰
- è€—æ—¶: 50-75ç§’ï¼ˆå‡å°‘50-67%ï¼‰
- è¯¯æŠ¥: 2-3ä¸ªï¼ˆå‡å°‘70-80%ï¼‰
- æˆæœ¬: 0.012å…ƒï¼ˆå‡å°‘52%ï¼‰
```

---

## ğŸš€ ä½¿ç”¨æŒ‡å—

### æ–¹å¼1ï¼šè‡ªåŠ¨å¯ç”¨ï¼ˆæ¨èï¼‰

ä¼˜åŒ–å·²é»˜è®¤å¯ç”¨ï¼Œæ— éœ€ä¿®æ”¹ä»£ç ï¼š

```python
# åœ¨ api/review.py ä¸­
reviewer = DocumentReviewer(
    rag_engine, 
    llm_service,
    enable_optimization=True  # é»˜è®¤å¯ç”¨
)

result = await reviewer.review_document(file_path, protocol_id)
```

### æ–¹å¼2ï¼šæ‰‹åŠ¨æ§åˆ¶

å¦‚æœéœ€è¦å¯¹æ¯”ä¼˜åŒ–æ•ˆæœï¼Œå¯ä»¥æ‰‹åŠ¨å¼€å…³ï¼š

```python
# å¯ç”¨ä¼˜åŒ–
reviewer_optimized = DocumentReviewer(
    rag_engine, llm_service, 
    enable_optimization=True
)

# ç¦ç”¨ä¼˜åŒ–ï¼ˆä½¿ç”¨åŸå§‹é€»è¾‘ï¼‰
reviewer_original = DocumentReviewer(
    rag_engine, llm_service, 
    enable_optimization=False
)

# å¯¹æ¯”æµ‹è¯•
result1 = await reviewer_optimized.review_document(file_path, protocol_id)
result2 = await reviewer_original.review_document(file_path, protocol_id)
```

---

## ğŸ”§ é…ç½®è°ƒä¼˜

### 1. è°ƒæ•´ç½®ä¿¡åº¦é˜ˆå€¼

åœ¨ `confidence_calibrator.py` ä¸­ï¼š

```python
# ä¿®æ”¹è§„åˆ™ç±»å‹æƒé‡
self.rule_type_weights = {
    "format": 1.3,      # æ›´ä¿¡ä»»æ ¼å¼ç±»è§„åˆ™
    "semantic": 0.8,    # æ›´è°¨æ…å¯¹å¾…è¯­ä¹‰ç±»è§„åˆ™
}

# ä¿®æ”¹ä¸¥é‡åº¦æƒé‡
self.severity_weights = {
    "high": 1.2,    # é«˜ä¸¥é‡åº¦è¦æ±‚æ›´é«˜ç½®ä¿¡åº¦
    "low": 0.85     # ä½ä¸¥é‡åº¦å¯ä»¥æ›´å®½æ¾
}
```

### 2. è°ƒæ•´è·³è¿‡è§„åˆ™

åœ¨ `review_optimizer.py` ä¸­ï¼š

```python
# ä¿®æ”¹æœ€å°æ–‡æœ¬é•¿åº¦
if not text or len(text) < 20:  # ä»15æ”¹ä¸º20
    return True, "æ–‡æœ¬å¤ªçŸ­"

# æ·»åŠ è‡ªå®šä¹‰è·³è¿‡è§„åˆ™
if "è‰ç¨¿" in text or "å¾…å®š" in text:
    return True, "è‰ç¨¿å†…å®¹"
```

### 3. è°ƒæ•´æ‰¹æ¬¡å¤§å°

```python
# åœ¨ review_optimizer.py ä¸­
def optimize_batch_size(self, total_chunks, avg_chunk_size):
    if total_chunks < 20:
        base_batch_size = 8  # ä»5æ”¹ä¸º8
    # ...
```

---

## ğŸ“ˆ ç›‘æ§å’Œè°ƒè¯•

### 1. æŸ¥çœ‹ä¼˜åŒ–ç»Ÿè®¡

```python
# è·å–ä¼˜åŒ–å™¨ç»Ÿè®¡ä¿¡æ¯
stats = optimizer.get_statistics()
print(f"è·³è¿‡ç‡: {stats['skip_rate']:.1f}%")
print(f"ç¼“å­˜å‘½ä¸­ç‡: {stats['cache_hit_rate']:.1f}%")
print(f"è·³è¿‡åŸå› åˆ†å¸ƒ: {stats['skip_reasons']}")
```

### 2. æŸ¥çœ‹ç½®ä¿¡åº¦æ ¡å‡†æ—¥å¿—

åœ¨æ—¥å¿—ä¸­æœç´¢ "ç½®ä¿¡åº¦æ ¡å‡†"ï¼š
```
ç½®ä¿¡åº¦æ ¡å‡†: R001 0.75 -> 0.68 (ç±»å‹:0.85, ä¸¥é‡åº¦:1.00, é•¿åº¦:0.80, ä¸Šä¸‹æ–‡:1.00, å†å²:1.00)
```

### 3. æŸ¥çœ‹æ€§èƒ½ç»Ÿè®¡

å®¡æ ¸ç»“æœä¸­åŒ…å«æ€§èƒ½ç»Ÿè®¡ï¼š
```python
result.summary["performance"]
# {
#   "total_time": "45.2s",
#   "parse_time": "2.1s",
#   "chunk_time": "1.5s",
#   "optimization_time": "3.2s",
#   "review_time": "38.4s",
#   "optimization_rate": "52.3%"
# }
```

---

## âš ï¸ æ³¨æ„äº‹é¡¹

### 1. ç¼“å­˜ç®¡ç†

ç¼“å­˜ä¼šå ç”¨å†…å­˜ï¼Œå»ºè®®å®šæœŸæ¸…ç†ï¼š

```python
# æ¸…ç©ºç¼“å­˜
optimizer.clear_cache()

# æŸ¥çœ‹ç¼“å­˜å¤§å°
cache_size = optimizer.get_cache_size()
print(f"ç¼“å­˜æ¡ç›®: {cache_size}")
```

### 2. è·³è¿‡è§„åˆ™çš„æƒè¡¡

- è·³è¿‡è§„åˆ™è¶Šä¸¥æ ¼ï¼Œé€Ÿåº¦è¶Šå¿«ï¼Œä½†å¯èƒ½æ¼æ‰é—®é¢˜
- å»ºè®®å…ˆç”¨å®½æ¾è§„åˆ™æµ‹è¯•ï¼Œå†æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´

### 3. ç½®ä¿¡åº¦æ ¡å‡†çš„å­¦ä¹ 

ç½®ä¿¡åº¦æ ¡å‡†å™¨æ”¯æŒå†å²å­¦ä¹ ï¼š

```python
# æ›´æ–°è§„åˆ™å‡†ç¡®ç‡ï¼ˆéœ€è¦äººå·¥æ ‡æ³¨ï¼‰
calibrator.update_history(rule_id="R001", is_correct=True)
calibrator.update_history(rule_id="R002", is_correct=False)
```

---

## ğŸ“ æœ€ä½³å®è·µ

### 1. é¦–æ¬¡ä½¿ç”¨

```python
# ç¬¬ä¸€æ¬¡å®¡æ ¸ï¼šå¯ç”¨ä¼˜åŒ–ï¼Œè§‚å¯Ÿæ•ˆæœ
result = await reviewer.review_document(file_path, protocol_id)

# æŸ¥çœ‹ä¼˜åŒ–ç»Ÿè®¡
print(result.summary["performance"])
```

### 2. å¯¹æ¯”æµ‹è¯•

```python
# å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ•ˆæœ
import time

# ä¼˜åŒ–ç‰ˆ
start = time.time()
result_opt = await reviewer_optimized.review_document(file_path, protocol_id)
time_opt = time.time() - start

# åŸå§‹ç‰ˆ
start = time.time()
result_orig = await reviewer_original.review_document(file_path, protocol_id)
time_orig = time.time() - start

print(f"ä¼˜åŒ–ç‰ˆ: {time_opt:.1f}s, é—®é¢˜æ•°: {result_opt.total_issues}")
print(f"åŸå§‹ç‰ˆ: {time_orig:.1f}s, é—®é¢˜æ•°: {result_orig.total_issues}")
print(f"é€Ÿåº¦æå‡: {(time_orig / time_opt - 1) * 100:.1f}%")
```

### 3. ç”Ÿäº§ç¯å¢ƒ

```python
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
reviewer = DocumentReviewer(
    rag_engine=rag_engine,
    llm_service=llm_service,
    enable_optimization=True,      # å¯ç”¨ä¼˜åŒ–
    use_cross_chunk_check=False    # å…³é—­è·¨æ®µè½æ£€æŸ¥ï¼ˆèŠ‚çœæ—¶é—´ï¼‰
)
```

---

## ğŸ“ æ€»ç»“

### å·²å®ç°çš„ä¼˜åŒ–ï¼š

âœ… **ç½®ä¿¡åº¦æ ¡å‡†**ï¼šå‡å°‘ 50% è¯¯æŠ¥
- å¤šç»´åº¦æƒé‡è®¡ç®—
- åŠ¨æ€é˜ˆå€¼è¿‡æ»¤
- ä¸Šä¸‹æ–‡ä¸€è‡´æ€§æ£€æŸ¥

âœ… **æ™ºèƒ½è·³è¿‡**ï¼šå‡å°‘ 30-50% LLMè°ƒç”¨
- 8ç§è·³è¿‡è§„åˆ™
- RAGé¢„æ£€ç´¢
- è‡ªåŠ¨ç»Ÿè®¡åˆ†æ

âœ… **ç›¸ä¼¼å—å»é‡**ï¼šå‡å°‘ 10-20% é‡å¤å®¡æ ¸
- MD5å“ˆå¸Œè¯†åˆ«
- ç´¢å¼•æ˜ å°„
- æ‰¹é‡å¤„ç†

âœ… **ç¼“å­˜æœºåˆ¶**ï¼šé¿å…é‡å¤è®¡ç®—
- æ–‡æœ¬å“ˆå¸Œç¼“å­˜
- è‡ªåŠ¨å‘½ä¸­æ£€æµ‹
- å†…å­˜ç®¡ç†

âœ… **æ‰¹æ¬¡ä¼˜åŒ–**ï¼šæå‡å¹¶å‘æ•ˆç‡
- åŠ¨æ€æ‰¹æ¬¡å¤§å°
- æ ¹æ®æ–‡æ¡£ç‰¹å¾è°ƒæ•´
- æ€§èƒ½ç›‘æ§

### ç»¼åˆæ•ˆæœï¼š

- ğŸš€ **é€Ÿåº¦æå‡**ï¼š2-3å€
- ğŸ¯ **å‡†ç¡®ç‡æå‡**ï¼šå‡å°‘50%è¯¯æŠ¥
- ğŸ’° **æˆæœ¬é™ä½**ï¼š50%
- ğŸ“Š **å¯è§‚æµ‹æ€§**ï¼šè¯¦ç»†ç»Ÿè®¡å’Œæ—¥å¿—

---

## ğŸ”— ç›¸å…³æ–‡ä»¶

- `backend/app/core/confidence_calibrator.py` - ç½®ä¿¡åº¦æ ¡å‡†å™¨
- `backend/app/core/review_optimizer.py` - æ™ºèƒ½å®¡æ ¸ä¼˜åŒ–å™¨
- `backend/app/core/reviewer.py` - ä¼˜åŒ–ç‰ˆå®¡æ ¸å™¨ï¼ˆå·²æ›´æ–°ï¼‰

---

## ğŸ“ é—®é¢˜åé¦ˆ

å¦‚æœé‡åˆ°é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š

1. æ—¥å¿—ä¸­çš„ä¼˜åŒ–ç»Ÿè®¡ä¿¡æ¯
2. ç½®ä¿¡åº¦æ ¡å‡†çš„è¿‡æ»¤æ—¥å¿—
3. è·³è¿‡åŸå› åˆ†å¸ƒ

å¯ä»¥é€šè¿‡è°ƒæ•´é…ç½®å‚æ•°æ¥ä¼˜åŒ–æ•ˆæœã€‚

