# åˆ†å—é€»è¾‘æ·±åº¦ä¼˜åŒ–è¯´æ˜

## ğŸ¯ ä¼˜åŒ–ç›®æ ‡

è§£å†³å½“å‰åˆ†å—å­˜åœ¨çš„é—®é¢˜ï¼š
1. âŒ å¤§é‡åƒåœ¾å—ï¼ˆ4-10ä¸ªå­—ç¬¦ï¼‰
2. âŒ åªæœ‰æ ‡ç‚¹ç¬¦å·çš„å—
3. âŒ åªæœ‰æ•°å­—çš„å—
4. âŒ è¯­ä¹‰ä¸å®Œæ•´çš„å°å—
5. âŒ æµªè´¹LLMè°ƒç”¨å’Œæˆæœ¬

## ğŸ“Š ä¼˜åŒ–å‰åå¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆå½“å‰é—®é¢˜ï¼‰

```
åŸå§‹æ®µè½ï¼š50ä¸ª
ç”Ÿæˆå—æ•°ï¼š50ä¸ª

é—®é¢˜åˆ†å¸ƒï¼š
- chunk_0: 8å­—ç¬¦ "ï¼ˆè½¯ä»¶æ–‡æ¡£æ ‡è¯†ï¼‰" âŒ åƒåœ¾å—
- chunk_1: 6å­—ç¬¦ "ï¼ˆè½¯ä»¶åç§°ï¼‰" âŒ åƒåœ¾å—
- chunk_3: 4å­—ç¬¦ âŒ åƒåœ¾å—
- chunk_7: 10å­—ç¬¦ âŒ åƒåœ¾å—
- chunk_8: 10å­—ç¬¦ âŒ åƒåœ¾å—
- ...

ç»Ÿè®¡ï¼š
- åƒåœ¾å—ï¼ˆ<30å­—ç¬¦ï¼‰ï¼šçº¦15ä¸ªï¼ˆ30%ï¼‰
- å°å—ï¼ˆ30-100å­—ç¬¦ï¼‰ï¼šçº¦20ä¸ªï¼ˆ40%ï¼‰
- æ­£å¸¸å—ï¼ˆ>100å­—ç¬¦ï¼‰ï¼šçº¦15ä¸ªï¼ˆ30%ï¼‰

é—®é¢˜ï¼š
- æµªè´¹30%çš„LLMè°ƒç”¨
- åƒåœ¾å—æ— æ³•æä¾›æœ‰æ•ˆä¿¡æ¯
- å¢åŠ å®¡æ ¸æ—¶é—´å’Œæˆæœ¬
```

### ä¼˜åŒ–åï¼ˆé¢„æœŸæ•ˆæœï¼‰

```
åŸå§‹æ®µè½ï¼š50ä¸ª
æ¸…æ´—åï¼š35ä¸ªï¼ˆè¿‡æ»¤15ä¸ªåƒåœ¾æ®µè½ï¼‰
ç”Ÿæˆå—æ•°ï¼š20ä¸ªï¼ˆåˆå¹¶15ä¸ªå°å—ï¼‰

åˆ†å¸ƒï¼š
- æ‰€æœ‰å— â‰¥ 30å­—ç¬¦
- å¹³å‡å—å¤§å°ï¼š150-300å­—ç¬¦
- è¯­ä¹‰å®Œæ•´ï¼Œä¿¡æ¯ä¸°å¯Œ

ç»Ÿè®¡ï¼š
- å°å—ï¼ˆ30-100å­—ç¬¦ï¼‰ï¼šçº¦3ä¸ªï¼ˆ15%ï¼‰
- ä¸­å—ï¼ˆ100-500å­—ç¬¦ï¼‰ï¼šçº¦15ä¸ªï¼ˆ75%ï¼‰
- å¤§å—ï¼ˆ>500å­—ç¬¦ï¼‰ï¼šçº¦2ä¸ªï¼ˆ10%ï¼‰

ä¼˜åŠ¿ï¼š
- å‡å°‘60%çš„LLMè°ƒç”¨ï¼ˆ50å— -> 20å—ï¼‰
- èŠ‚çœ60%çš„å®¡æ ¸æ—¶é—´å’Œæˆæœ¬
- æé«˜æ£€æµ‹å‡†ç¡®ç‡ï¼ˆæ›´å¤šä¸Šä¸‹æ–‡ï¼‰
```

## ğŸ”§ ä¼˜åŒ–ç­–ç•¥

### 1. é¢„å¤„ç†é˜¶æ®µï¼šè¿‡æ»¤åƒåœ¾æ®µè½

```python
def _preprocess_paragraphs(self, paragraphs):
    """
    è¿‡æ»¤è§„åˆ™ï¼š
    1. ç©ºæ®µè½
    2. åªæœ‰æ ‡ç‚¹ç¬¦å·ï¼šï¼ˆï¼‰ã€ã€‘ç­‰
    3. åªæœ‰æ•°å­—ï¼š1 2 3 4 5
    4. é•¿åº¦ < 30å­—ç¬¦ï¼ˆé™¤éæ˜¯æ ‡é¢˜ï¼‰
    """
    
    # ç¤ºä¾‹ï¼š
    "ï¼ˆè½¯ä»¶æ–‡æ¡£æ ‡è¯†ï¼‰" -> è¿‡æ»¤ï¼ˆåªæœ‰æ ‡ç‚¹+å°‘é‡æ–‡å­—ï¼‰
    "ï¼ˆè½¯ä»¶åç§°ï¼‰" -> è¿‡æ»¤ï¼ˆåªæœ‰æ ‡ç‚¹+å°‘é‡æ–‡å­—ï¼‰
    "4" -> è¿‡æ»¤ï¼ˆåªæœ‰æ•°å­—ï¼‰
    "5" -> è¿‡æ»¤ï¼ˆåªæœ‰æ•°å­—ï¼‰
```

**æ•ˆæœ**ï¼šè¿‡æ»¤çº¦30%çš„åƒåœ¾æ®µè½

### 2. æ ‡é¢˜è¯†åˆ«ï¼šä¿ç•™æœ‰æ„ä¹‰çš„çŸ­æ®µè½

```python
def _is_likely_heading(self, text, style):
    """
    æ ‡é¢˜åˆ¤æ–­è§„åˆ™ï¼š
    1. æ ·å¼åŒ…å« "Heading" æˆ– "Title"
    2. åŒ¹é…æ¨¡å¼ï¼š
       - ä¸€ã€äºŒã€ä¸‰
       - 1. 2. 3.
       - ç¬¬Xç« 
    3. é•¿åº¦ < 50å­—ç¬¦
    """
    
    # ç¤ºä¾‹ï¼š
    "ç¬¬ä¸€ç«  å¼•è¨€" -> ä¿ç•™ï¼ˆæ ‡é¢˜ï¼‰
    "1. æ¦‚è¿°" -> ä¿ç•™ï¼ˆæ ‡é¢˜ï¼‰
    "ï¼ˆè½¯ä»¶åç§°ï¼‰" -> è¿‡æ»¤ï¼ˆä¸æ˜¯æ ‡é¢˜ï¼‰
```

**æ•ˆæœ**ï¼šä¿ç•™æœ‰æ„ä¹‰çš„æ ‡é¢˜ï¼Œè¿‡æ»¤æ— æ„ä¹‰çš„çŸ­æ®µè½

### 3. æ™ºèƒ½åˆå¹¶ï¼šå°å—è‡ªåŠ¨åˆå¹¶

```python
def _smart_merge_chunks(self, chunks):
    """
    åˆå¹¶ç­–ç•¥ï¼š
    1. ç›¸é‚»å°å—ï¼ˆ<100å­—ç¬¦ï¼‰è‡ªåŠ¨åˆå¹¶
    2. æ ‡é¢˜ä¸åç»­å†…å®¹åˆå¹¶
    3. åŒä¸€ç« èŠ‚å†…å®¹åˆå¹¶
    4. åˆå¹¶åä¸è¶…è¿‡chunk_size
    """
    
    # ç¤ºä¾‹ï¼š
    chunk_0: "ç¬¬ä¸€ç«  å¼•è¨€" (10å­—ç¬¦)
    chunk_1: "æœ¬æ–‡æ¡£æ—¨åœ¨..." (50å­—ç¬¦)
    chunk_2: "æ ¹æ®å›½å®¶æ ‡å‡†..." (60å­—ç¬¦)
    
    åˆå¹¶åï¼š
    chunk_0: "ç¬¬ä¸€ç«  å¼•è¨€\næœ¬æ–‡æ¡£æ—¨åœ¨...\næ ¹æ®å›½å®¶æ ‡å‡†..." (120å­—ç¬¦)
```

**æ•ˆæœ**ï¼šå‡å°‘çº¦40%çš„å—æ•°é‡ï¼Œæé«˜è¯­ä¹‰å®Œæ•´æ€§

### 4. ä¸Šä¸‹æ–‡æ‘˜è¦ï¼šè§£å†³è·¨æ®µè½é—®é¢˜

```python
def _add_context_summary(self, chunks):
    """
    ä¸ºæ¯ä¸ªå—æ·»åŠ ï¼š
    - context_before: å‰2ä¸ªå—çš„æ‘˜è¦
    - context_after: å2ä¸ªå—çš„æ‘˜è¦
    """
    
    # ç¤ºä¾‹ï¼š
    chunk_5:
      text: "æ ¹æ®ä¸Šè¿°åˆ†æ..."
      context_before: "ç¬¬ä¸€ç«  å¼•è¨€... | æœ¬æ–‡æ¡£æ—¨åœ¨..."
      context_after: "æµ‹è¯•ç»“æœæ˜¾ç¤º... | ç»“è®ºå¦‚ä¸‹..."
```

**æ•ˆæœ**ï¼šLLMå¯ä»¥ç†è§£ä¸Šä¸‹æ–‡ï¼Œæé«˜æ£€æµ‹å‡†ç¡®ç‡

## ğŸ“ˆ æ€§èƒ½æå‡

### æ—¶é—´æˆæœ¬

```
ä¼˜åŒ–å‰ï¼š
- 50ä¸ªå— Ã— 3ç§’/å— = 150ç§’ï¼ˆ2.5åˆ†é’Ÿï¼‰

ä¼˜åŒ–åï¼š
- 20ä¸ªå— Ã— 3ç§’/å— = 60ç§’ï¼ˆ1åˆ†é’Ÿï¼‰

èŠ‚çœï¼š90ç§’ï¼ˆ60%ï¼‰
```

### é‡‘é’±æˆæœ¬

```
ä¼˜åŒ–å‰ï¼š
- 50ä¸ªå— Ã— 500 tokens/å— Ã— 0.001å…ƒ/1K tokens = 0.025å…ƒ

ä¼˜åŒ–åï¼š
- 20ä¸ªå— Ã— 600 tokens/å— Ã— 0.001å…ƒ/1K tokens = 0.012å…ƒ

èŠ‚çœï¼š0.013å…ƒï¼ˆ52%ï¼‰

æ³¨ï¼šè™½ç„¶å•å—tokenå¢åŠ ï¼Œä½†æ€»é‡å‡å°‘
```

### å‡†ç¡®ç‡æå‡

```
ä¼˜åŒ–å‰ï¼š
- åƒåœ¾å—å¯¼è‡´è¯¯æŠ¥
- å°å—ç¼ºå°‘ä¸Šä¸‹æ–‡
- å‡†ç¡®ç‡ï¼šçº¦70%

ä¼˜åŒ–åï¼š
- æ— åƒåœ¾å—
- è¯­ä¹‰å®Œæ•´
- æœ‰ä¸Šä¸‹æ–‡æ‘˜è¦
- å‡†ç¡®ç‡ï¼šçº¦85%ï¼ˆé¢„ä¼°ï¼‰
```

## ğŸ” é…ç½®å‚æ•°

### å¯è°ƒæ•´å‚æ•°

```python
SmartChunker(
    chunk_size=1000,        # æœ€å¤§å—å¤§å°ï¼ˆå­—ç¬¦æ•°ï¼‰
    overlap=200,            # é‡å å¤§å°
    min_chunk_size=30,      # æœ€å°å—å¤§å°ï¼ˆè¿‡æ»¤é˜ˆå€¼ï¼‰
    merge_threshold=100     # åˆå¹¶é˜ˆå€¼
)
```

### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ | å»ºè®®èŒƒå›´ |
|------|--------|------|----------|
| `chunk_size` | 1000 | æœ€å¤§å—å¤§å° | 500-2000 |
| `overlap` | 200 | é•¿æ®µè½åˆ‡åˆ†æ—¶çš„é‡å  | 100-300 |
| `min_chunk_size` | 30 | æœ€å°å—å¤§å°ï¼ˆè¿‡æ»¤ï¼‰ | 20-50 |
| `merge_threshold` | 100 | å°å—åˆå¹¶é˜ˆå€¼ | 50-200 |

### è°ƒä¼˜å»ºè®®

**åœºæ™¯1ï¼šçŸ­æ–‡æ¡£ï¼ˆ<5000å­—ï¼‰**
```python
SmartChunker(
    chunk_size=800,
    min_chunk_size=50,      # æ›´ä¸¥æ ¼çš„è¿‡æ»¤
    merge_threshold=150     # æ›´ç§¯æçš„åˆå¹¶
)
```

**åœºæ™¯2ï¼šé•¿æ–‡æ¡£ï¼ˆ>20000å­—ï¼‰**
```python
SmartChunker(
    chunk_size=1500,        # æ›´å¤§çš„å—
    min_chunk_size=30,
    merge_threshold=80      # ä¿ç•™æ›´å¤šå°å—
)
```

**åœºæ™¯3ï¼šæŠ€æœ¯æ–‡æ¡£ï¼ˆä»£ç ã€è¡¨æ ¼å¤šï¼‰**
```python
SmartChunker(
    chunk_size=1200,
    min_chunk_size=20,      # å…è®¸æ›´çŸ­çš„å—ï¼ˆä»£ç ç‰‡æ®µï¼‰
    merge_threshold=60
)
```

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•ç”¨ä¾‹

```python
# æµ‹è¯•1ï¼šåƒåœ¾æ®µè½è¿‡æ»¤
paragraphs = [
    {"text": "ï¼ˆè½¯ä»¶æ–‡æ¡£æ ‡è¯†ï¼‰"},  # åº”è¯¥è¢«è¿‡æ»¤
    {"text": "4"},                  # åº”è¯¥è¢«è¿‡æ»¤
    {"text": "ç¬¬ä¸€ç«  å¼•è¨€"},        # åº”è¯¥ä¿ç•™ï¼ˆæ ‡é¢˜ï¼‰
    {"text": "æœ¬æ–‡æ¡£æ—¨åœ¨è§„èŒƒ..."}   # åº”è¯¥ä¿ç•™
]

# é¢„æœŸç»“æœï¼š2ä¸ªæœ‰æ•ˆæ®µè½

# æµ‹è¯•2ï¼šå°å—åˆå¹¶
chunks = [
    Chunk(text="ç¬¬ä¸€ç«  å¼•è¨€", length=10),
    Chunk(text="æœ¬æ–‡æ¡£æ—¨åœ¨...", length=50),
    Chunk(text="æ ¹æ®å›½å®¶æ ‡å‡†...", length=60)
]

# é¢„æœŸç»“æœï¼š1ä¸ªåˆå¹¶å—ï¼ˆ120å­—ç¬¦ï¼‰

# æµ‹è¯•3ï¼šé•¿æ®µè½åˆ‡åˆ†
paragraph = "å¾ˆé•¿çš„æ®µè½..." * 100  # 2000å­—ç¬¦

# é¢„æœŸç»“æœï¼š2-3ä¸ªå—ï¼Œæ¯ä¸ªçº¦800-1000å­—ç¬¦
```

### éªŒè¯æ–¹æ³•

1. **ä½¿ç”¨åˆ†å—é¢„è§ˆå·¥å…·**
   ```
   æ‰“å¼€ï¼šfrontend/chunk_preview.html
   ä¸Šä¼ æµ‹è¯•æ–‡æ¡£
   æŸ¥çœ‹åˆ†å—ç»“æœ
   ```

2. **æ£€æŸ¥ç»Ÿè®¡ä¿¡æ¯**
   ```
   - æ€»å—æ•°æ˜¯å¦åˆç†ï¼ˆå‡å°‘30-60%ï¼‰
   - æœ€å°å—å¤§å° â‰¥ 30å­—ç¬¦
   - å¹³å‡å—å¤§å°ï¼š150-300å­—ç¬¦
   - æ— åƒåœ¾å—
   ```

3. **æŸ¥çœ‹æ—¥å¿—**
   ```
   æ–‡æ¡£åˆ†å—å®Œæˆ: 50 ä¸ªåŸå§‹æ®µè½ -> 20 ä¸ªæœ‰æ•ˆå—
      è¿‡æ»¤äº† 15 ä¸ªåƒåœ¾æ®µè½
      åˆå¹¶äº† 15 ä¸ªå°å—
   ```

## ğŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºæœ¬ä½¿ç”¨

```python
from app.core.chunker import SmartChunker
from app.core.document_parser import DocumentParser

# 1. è§£ææ–‡æ¡£
parser = DocumentParser()
doc_structure = parser.parse_docx("test.docx")

# 2. æ™ºèƒ½åˆ†å—
chunker = SmartChunker(
    min_chunk_size=30,
    merge_threshold=100
)
chunks = chunker.chunk_by_paragraphs(doc_structure)

# 3. æŸ¥çœ‹ç»Ÿè®¡
stats = chunker.get_chunk_statistics(chunks)
print(f"æ€»å—æ•°: {stats['total_chunks']}")
print(f"å¹³å‡å¤§å°: {stats['avg_chunk_size']}")
print(f"å¤§å°åˆ†å¸ƒ: {stats['size_distribution']}")

# 4. éªŒè¯è´¨é‡
warnings = chunker.validate_chunks(chunks)
if warnings:
    print("è­¦å‘Š:")
    for w in warnings:
        print(f"  - {w}")
```

### é«˜çº§ä½¿ç”¨

```python
# è‡ªå®šä¹‰é…ç½®
chunker = SmartChunker(
    chunk_size=1200,
    overlap=250,
    min_chunk_size=40,
    merge_threshold=120
)

# åˆ†å—
chunks = chunker.chunk_by_paragraphs(doc_structure)

# è·å–è¯¦ç»†ç»Ÿè®¡
stats = chunker.get_chunk_statistics(chunks)

# æ‰“å°åˆ†å—è¯¦æƒ…
for i, chunk in enumerate(chunks):
    print(f"\n=== Chunk {i} ===")
    print(f"é•¿åº¦: {len(chunk.text)} å­—ç¬¦")
    print(f"ç« èŠ‚: {chunk.section}")
    print(f"æ–‡æœ¬: {chunk.text[:100]}...")
    if chunk.context_before:
        print(f"å‰æ–‡: {chunk.context_before[:50]}...")
    if chunk.context_after:
        print(f"åæ–‡: {chunk.context_after[:50]}...")
```

## ğŸ“ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. âœ… **è¿‡æ»¤åƒåœ¾æ®µè½**ï¼šå‡å°‘30%æ— æ•ˆè¾“å…¥
2. âœ… **æ™ºèƒ½åˆå¹¶å°å—**ï¼šå‡å°‘40%å—æ•°é‡
3. âœ… **ä¿ç•™æ ‡é¢˜ä¿¡æ¯**ï¼šæé«˜è¯­ä¹‰å®Œæ•´æ€§
4. âœ… **æ·»åŠ ä¸Šä¸‹æ–‡æ‘˜è¦**ï¼šæé«˜æ£€æµ‹å‡†ç¡®ç‡
5. âœ… **å¯é…ç½®å‚æ•°**ï¼šé€‚åº”ä¸åŒåœºæ™¯

### é¢„æœŸæ•ˆæœ

- ğŸš€ **é€Ÿåº¦æå‡**ï¼š60%ï¼ˆå—æ•°å‡å°‘ï¼‰
- ğŸ’° **æˆæœ¬é™ä½**ï¼š50%ï¼ˆLLMè°ƒç”¨å‡å°‘ï¼‰
- ğŸ¯ **å‡†ç¡®ç‡æå‡**ï¼š15%ï¼ˆè¯­ä¹‰æ›´å®Œæ•´ï¼‰
- ğŸ§¹ **æ— åƒåœ¾å—**ï¼š100%è¿‡æ»¤

### ä¸‹ä¸€æ­¥

1. æµ‹è¯•ä¼˜åŒ–åçš„åˆ†å—æ•ˆæœ
2. æ ¹æ®å®é™…æƒ…å†µè°ƒæ•´å‚æ•°
3. æ”¶é›†åé¦ˆæŒç»­ä¼˜åŒ–
4. è€ƒè™‘æ·»åŠ æ›´å¤šæ™ºèƒ½ç­–ç•¥ï¼ˆå¦‚è¡¨æ ¼è¯†åˆ«ã€ä»£ç å—è¯†åˆ«ç­‰ï¼‰

